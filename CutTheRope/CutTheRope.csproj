<?xml version="1.0" encoding="utf-8"?>
<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <ProjectGuid>{9A732C70-39B7-456E-8029-91F641C29567}</ProjectGuid>
    <RootNamespace>CutTheRope</RootNamespace>
    <AssemblyName>CutTheRope-DX</AssemblyName>

    <!-- Default: cross-platform DesktopGL -->
    <TargetFrameworks>net10.0</TargetFrameworks>
    <!-- macOS: add net10.0-macos for AVFoundation -->
    <TargetFrameworks Condition="$([MSBuild]::IsOsPlatform('OSX'))">
      net10.0;net10.0-macos
    </TargetFrameworks>
    <LangVersion>preview</LangVersion>

    <AllowUnsafeBlocks>True</AllowUnsafeBlocks>
    <ApplicationIcon Condition="$([MSBuild]::IsOsPlatform('Windows'))">../distribution/icons/CutTheRopeDXIcon.ico</ApplicationIcon>
    <VersionPrefix>1.0.0</VersionPrefix>
    <VersionSuffix>dirty</VersionSuffix>
    <Company>ZeptoLab</Company>
    <Product>Cut The Rope: DX</Product>
    <Description>Cut the Rope: DX, a fan-made enhancement of the PC version of Cut the Rope.</Description>
    <Copyright>Copyright Â© 2012</Copyright>
    <NeutralLanguage>en-US</NeutralLanguage>
    <EnableNETAnalyzers>true</EnableNETAnalyzers>
    <AnalysisMode>Recommended</AnalysisMode>
    <EnforceCodeStyleInBuild>true</EnforceCodeStyleInBuild>
    <CodeAnalysisTreatWarningsAsErrors>false</CodeAnalysisTreatWarningsAsErrors>
    <IsAotCompatible>true</IsAotCompatible>
    <TieredCompilation>false</TieredCompilation>
    <IncludeSourceRevisionInInformationalVersion Condition="'$(VersionSuffix)' != ''">true</IncludeSourceRevisionInInformationalVersion>
    <IncludeSourceRevisionInInformationalVersion Condition="'$(VersionSuffix)' == ''">false</IncludeSourceRevisionInInformationalVersion>

    <!-- Default: build content -->
    <RunMGCB>true</RunMGCB>

    <!-- Auto-disable in CI (GitHub Actions, GitLab, Azure, etc. set CI=true) -->
    <RunMGCB Condition="'$(CI)' == 'true'">false</RunMGCB>
  </PropertyGroup>

  <!-- Output type -->
  <PropertyGroup Condition="'$(Configuration)' == 'Debug'">
    <OutputType>Exe</OutputType>
  </PropertyGroup>

  <PropertyGroup Condition="'$(Configuration)' == 'Release' AND $([MSBuild]::IsOsPlatform('Windows'))">
    <OutputType>WinExe</OutputType>
  </PropertyGroup>

  <PropertyGroup Condition="'$(Configuration)' == 'Release' AND !$([MSBuild]::IsOsPlatform('Windows'))">
    <OutputType>Exe</OutputType>
  </PropertyGroup>

  <!-- DesktopGL publish defaults -->
  <PropertyGroup Condition="'$(RuntimeIdentifier)' != ''">
    <SelfContained>true</SelfContained>
    <PublishSingleFile>true</PublishSingleFile>
    <PublishReadyToRun>false</PublishReadyToRun>
    <StripSymbols>true</StripSymbols>
    <DebugType>none</DebugType>
  </PropertyGroup>

  <!-- macOS app bundle doesn't support single-file publishing -->
  <PropertyGroup Condition="'$(TargetFramework)' == 'net10.0-macos'">
    <SelfContained>true</SelfContained>
    <PublishSingleFile>false</PublishSingleFile>
    <PublishReadyToRun>false</PublishReadyToRun>
  </PropertyGroup>

  <PropertyGroup Condition="'$(TargetFramework)' == 'net10.0-macos'">
    <ApplicationId>page.yell0wsuit.cuttherope.dx</ApplicationId>
    <SupportedOSPlatformVersion>26.0</SupportedOSPlatformVersion>
  </PropertyGroup>

  <ItemGroup Condition="'$(TargetFramework)' == 'net10.0-macos'">
    <PartialAppManifest Include="../distribution/macos/InfoCsproj.plist" />
  </ItemGroup>

  <ItemGroup Condition="'$(TargetFramework)' == 'net10.0-macos'">
    <BundleResource Include="../distribution/icons/CutTheRopeDXIcon.icns">
      <Link>CutTheRopeDXIcon.icns</Link>
    </BundleResource>
  </ItemGroup>

  <ItemGroup>
    <PackageReference Include="DiscordRichPresence" Version="1.6.1.70" />
    <PackageReference
      Include="FontStashSharp.MonoGame"
      Version="1.5.2"
    />
    <PackageReference
      Include="MonoGame.Content.Builder.Task"
      Version="3.8.4.1"
    />
    <PackageReference
      Include="MonoGame.Framework.DesktopGL"
      Version="3.8.4.1"
    />
  </ItemGroup>

  <!-- VLC video player for Windows and Linux -->
  <ItemGroup
    Condition="!$(RuntimeIdentifier.StartsWith('osx')) AND ( '$(RuntimeIdentifier)' != '' OR !$([MSBuild]::IsOsPlatform('OSX')) )">
    <PackageReference Include="LibVLCSharp" Version="3.9.5" />
  </ItemGroup>

  <!-- Windows: bundled native VLC libraries -->
  <ItemGroup
    Condition="$(RuntimeIdentifier.StartsWith('win')) OR ( '$(RuntimeIdentifier)' == '' AND $([MSBuild]::IsOsPlatform('Windows')) )">
    <PackageReference Include="VideoLAN.LibVLC.Windows" Version="3.0.23" />
  </ItemGroup>

  <!-- FFmpeg for macOS DesktopGL builds -->
  <ItemGroup Condition="'$(TargetFramework)' == 'net10.0' AND $([MSBuild]::IsOsPlatform('OSX'))">
    <PackageReference Include="FFmpeg.AutoGen" Version="8.0.0" />
  </ItemGroup>

  <!-- Compiler constants for DesktopGL builds. -->
  <PropertyGroup>
    <DefineConstants>$(DefineConstants);MONOGAME_DESKTOPGL</DefineConstants>
  </PropertyGroup>

  <!-- Support for AVFoundation for macOS Tahoe (26) -->
  <PropertyGroup Condition="'$(TargetFramework)' == 'net10.0-macos'">
    <DefineConstants>$(DefineConstants);MACOS_AVFOUNDATION</DefineConstants>
  </PropertyGroup>

  <!-- Use Ffmpeg for macOS below 26 and net10.0 -->
  <PropertyGroup Condition="'$(TargetFramework)' == 'net10.0' AND $([MSBuild]::IsOsPlatform('OSX'))">
    <DefineConstants>$(DefineConstants);MACOS_FFMPEG</DefineConstants>
  </PropertyGroup>

  <!-- VLC enabled on all platforms except macOS -->
  <PropertyGroup
    Condition="!$(RuntimeIdentifier.StartsWith('osx')) AND ( '$(RuntimeIdentifier)' != '' OR !$([MSBuild]::IsOsPlatform('OSX')) )">
    <DefineConstants>$(DefineConstants);DESKTOPGL_VLC</DefineConstants>
  </PropertyGroup>

  <ItemGroup>
    <EmbeddedResource Include="Microsoft.Xna.Framework.RuntimeProfile" />
  </ItemGroup>
  <ItemGroup>
    <None Include="app.manifest" />
  </ItemGroup>

  <!-- Copy content files for non-macOS builds, exclude sounds (handled separately). -->
  <ItemGroup Condition="'$(TargetFramework)' != 'net10.0-macos'">
    <None
      Include="..\content\**"
      Exclude="..\content\sounds\**;..\content\**\.DS_Store"
    >
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
      <Link>content\%(RecursiveDir)%(Filename)%(Extension)</Link>
    </None>
  </ItemGroup>

  <ItemGroup Condition="'$(TargetFramework)' != 'net10.0-macos'">
    <None Remove="..\content\content.mgcb" />
    <None Remove="..\content\bin\**\*.*" />
    <None Remove="..\content\obj\**\*.*" />
    <None Remove="..\content\**\*.png" />
    <None Remove="..\content\sounds\sfx\*.wav" />
  </ItemGroup>

  <!-- macOS app bundle: use BundleResource for content files -->
  <ItemGroup Condition="'$(TargetFramework)' == 'net10.0-macos'">
    <BundleResource
      Include="..\content\**"
      Exclude="..\content\sounds\**;..\content\content.mgcb;..\content\bin\**\*.*;..\content\obj\**\*.*;..\content\**\*.png;..\content\sounds\sfx\*.wav"
    >
      <Link>content\%(RecursiveDir)%(Filename)%(Extension)</Link>
    </BundleResource>
  </ItemGroup>

  <!-- OpenGL build, include *.xnb and *.ogg pairs (excluding *_windows.*). -->
  <ItemGroup Condition="'$(TargetFramework)' == 'net10.0'">
    <None
      Include="..\content\sounds\*.xnb"
      Exclude="..\content\sounds\*_windows.xnb"
    >
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
      <Link>content\sounds\%(Filename)%(Extension)</Link>
    </None>
    <None Include="..\content\sounds\*.ogg">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
      <Link>content\sounds\%(Filename)%(Extension)</Link>
    </None>
  </ItemGroup>

  <!-- macOS app bundle: sound files as BundleResource -->
  <ItemGroup Condition="'$(TargetFramework)' == 'net10.0-macos'">
    <BundleResource
      Include="..\content\sounds\*.xnb"
      Exclude="..\content\sounds\*_windows.xnb"
    >
      <Link>content\sounds\%(Filename)%(Extension)</Link>
    </BundleResource>
    <BundleResource Include="..\content\sounds\*.ogg">
      <Link>content\sounds\%(Filename)%(Extension)</Link>
    </BundleResource>
  </ItemGroup>

  <!-- OpenGL build, include alsoft.ini to disable HTRF. -->
  <ItemGroup Condition="'$(TargetFramework)' == 'net10.0'">
    <None Include="..\alsoft.ini">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
    </None>
  </ItemGroup>

  <!-- macOS app bundle: alsoft.ini as BundleResource -->
  <ItemGroup Condition="'$(TargetFramework)' == 'net10.0-macos'">
    <BundleResource Include="..\alsoft.ini">
      <Link>alsoft.ini</Link>
    </BundleResource>
  </ItemGroup>

  <ItemGroup Condition="'$(RunMGCB)' == 'true'">
    <MonoGameContentReference Include="..\content\content.mgcb" />
  </ItemGroup>

  <ItemGroup>
    <EmbeddedResource Include="../distribution/icons/CutTheRopeDXIcon.bmp">
      <LogicalName>Icon.bmp</LogicalName>
    </EmbeddedResource>
  </ItemGroup>

  <ItemGroup Condition="'$(RuntimeIdentifier)' != '' AND $(RuntimeIdentifier.StartsWith('osx'))">
    <None Include="../distribution/icons/CutTheRopeDXIcon.icns">
      <Link>Resources/CutTheRopeDXIcon.icns</Link>
      <CopyToPublishDirectory>Always</CopyToPublishDirectory>
    </None>
  </ItemGroup>

  <Target
    Name="RestoreDotnetTools"
    BeforeTargets="CollectPackageReferences"
  >
    <Message
      Text="Restoring dotnet tools (this might take a while depending on your internet speed and should only happen upon building your project for the first time, or after upgrading MonoGame, or clearing your nuget cache)"
      Importance="High"
    />
    <Exec Command="dotnet tool restore" />
  </Target>

  <!--
    macOS: codesign dylibs and the app bundle after build.
    This must be done to avoid app crashes when opening (thanks macOS).
  -->
  <Target
    Name="CodesignMacOSBundle"
    AfterTargets="Build"
    Condition="'$(TargetFramework)' == 'net10.0-macos' AND '$(RuntimeIdentifier)' != '' AND $([MSBuild]::IsOsPlatform('OSX'))"
  >
    <PropertyGroup>
      <AppBundlePath>$([MSBuild]::NormalizePath($([MSBuild]::EnsureTrailingSlash('$(OutputPath)'))$(AssemblyName).app))</AppBundlePath>
    </PropertyGroup>
    
    <Message Text="Codesigning dylibs in $(AppBundlePath)..." Importance="High" />
    
    <!-- Sign all dylibs - using bash to avoid escaping hell -->
    <Exec
      Command="/bin/bash -c &quot;find '$(AppBundlePath)' -name '*.dylib' -print0 | xargs -0 -I {} codesign --force --sign - '{}'&quot;" 
      IgnoreExitCode="false"
    />
    
    <!-- Sign the bundle itself -->
    <Exec Command="codesign --force --sign - &quot;$(AppBundlePath)&quot;" IgnoreExitCode="false" />
  </Target>

  <Target
    Name="MoveMacOSAppToPublish"
    AfterTargets="Publish"
    Condition="'$(TargetFramework)' == 'net10.0-macos' AND '$(RuntimeIdentifier)' != '' AND $([MSBuild]::IsOsPlatform('OSX'))"
  >
    <PropertyGroup>
      <AppBundleName>$(AssemblyName).app</AppBundleName>
      <AppSourcePath>$([MSBuild]::NormalizePath($([MSBuild]::EnsureTrailingSlash('$(OutputPath)'))$(AppBundleName)))</AppSourcePath>
      <AppPublishPath>$([MSBuild]::NormalizePath($([MSBuild]::EnsureTrailingSlash('$(PublishDir)'))$(AppBundleName)))</AppPublishPath>
    </PropertyGroup>

    <Message Text="Relocating macOS .app to publish directory" Importance="High" />

    <Exec
      Condition="Exists('$(AppSourcePath)')"
      Command="/bin/mv &quot;$(AppSourcePath)&quot; &quot;$(AppPublishPath)&quot;"
    />
  </Target>
</Project>
