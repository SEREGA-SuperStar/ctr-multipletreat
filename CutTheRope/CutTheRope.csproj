<?xml version="1.0" encoding="utf-8"?>
<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <ProjectGuid>{9A732C70-39B7-456E-8029-91F641C29567}</ProjectGuid>
    <OutputType Condition="'$(Configuration)' == 'Debug'">Exe</OutputType>
    <OutputType Condition="'$(Configuration)' == 'Release'">WinExe</OutputType>
    <RootNamespace>CutTheRope</RootNamespace>
    <AssemblyName>CutTheRope-DX</AssemblyName>

    <!--
      Multi-targeting setup:
        - Without -r flag: Builds BOTH net9.0-windows (WindowsDX) AND net9.0 (DesktopGL)
        - With -r win-x64: Builds ONLY net9.0-windows (WindowsDX)
        - With -r linux-x64 or -r osx-x64: Builds ONLY net9.0 (DesktopGL)
      
      Note: TargetFrameworks (plural) is the input list you define.
            TargetFramework (singular with `$()`) is the runtime value during each build pass.
            MSBuild builds the project once for each framework in the list.
    -->

    <TargetFrameworks>net9.0</TargetFrameworks>
    <TargetFrameworks Condition="$([MSBuild]::IsOsPlatform('Windows'))">net9.0-windows;net9.0</TargetFrameworks>

    <AllowUnsafeBlocks>True</AllowUnsafeBlocks>
    <ApplicationManifest Condition="'$(TargetFramework)' == 'net9.0-windows'">app.manifest</ApplicationManifest>
    <ApplicationIcon Condition="'$(TargetFramework)' == 'net9.0-windows'">../distribution/icons/CutTheRopeIcon.ico</ApplicationIcon>
    <AssemblyVersion>2.4.10.1</AssemblyVersion>
    <FileVersion>2.4.10.1</FileVersion>
    <InformationalVersion>2.4.10.1</InformationalVersion>
    <Company>ZeptoLab</Company>
    <Product>Cut The Rope: DX</Product>
    <Description>Cut the Rope: DX, a fan-made enhancement of the PC version of Cut the Rope.</Description>
    <Copyright>Copyright © 2012</Copyright>
    <NeutralLanguage>en-US</NeutralLanguage>
    <EnableNETAnalyzers>true</EnableNETAnalyzers>
    <AnalysisMode>Recommended</AnalysisMode>
    <EnforceCodeStyleInBuild>true</EnforceCodeStyleInBuild>
    <CodeAnalysisTreatWarningsAsErrors>false</CodeAnalysisTreatWarningsAsErrors>
    <TieredCompilation>false</TieredCompilation>
    <IncludeSourceRevisionInInformationalVersion>false</IncludeSourceRevisionInInformationalVersion>

    <!-- Default: build content -->
    <RunMGCB>true</RunMGCB>

    <!-- Auto-disable in CI (GitHub Actions, GitLab, Azure, etc. set CI=true) -->
    <RunMGCB Condition="'$(CI)' == 'true'">false</RunMGCB>
  </PropertyGroup>

  <!-- DesktopGL publish defaults (macOS / Linux) -->
  <PropertyGroup Condition="'$(TargetFramework)' == 'net9.0' AND '$(RuntimeIdentifier)' != ''">
    <SelfContained>true</SelfContained>
    <PublishSingleFile>true</PublishSingleFile>
    <PublishReadyToRun>false</PublishReadyToRun>
  </PropertyGroup>

  <!-- WindowsDX build defaults -->
  <PropertyGroup Condition="'$(TargetFramework)' == 'net9.0-windows'">
    <SelfContained>false</SelfContained>
    <PublishSingleFile>false</PublishSingleFile>
    <PublishReadyToRun>false</PublishReadyToRun>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="DiscordRichPresence" Version="1.6.1.70" />
    <PackageReference
      Include="FontStashSharp.MonoGame"
      Version="1.5.2"
    />
    <PackageReference
      Include="MonoGame.Content.Builder.Task"
      Version="3.8.4.1"
    />
  </ItemGroup>

  <!-- When building net9.0-windows, use WindowsDX backend -->
  <ItemGroup Condition="'$(TargetFramework)' == 'net9.0-windows'">
    <PackageReference
      Include="MonoGame.Framework.WindowsDX"
      Version="3.8.4.1"
    />
  </ItemGroup>

  <!-- When building net9.0, use DesktopGL backend (cross-platform) -->
  <ItemGroup Condition="'$(TargetFramework)' == 'net9.0'">
    <PackageReference
      Include="MonoGame.Framework.DesktopGL"
      Version="3.8.4.1"
    />
  </ItemGroup>

  <!-- Compiler constants for WindowsDX builds. -->
  <PropertyGroup Condition="'$(TargetFramework)' == 'net9.0-windows'">
    <DefineConstants>$(DefineConstants);MONOGAME_WINDOWSDX</DefineConstants>
  </PropertyGroup>

  <!-- Compiler constants for DesktopGL builds. -->
  <PropertyGroup Condition="'$(TargetFramework)' == 'net9.0'">
    <DefineConstants>$(DefineConstants);MONOGAME_DESKTOPGL</DefineConstants>
  </PropertyGroup>

  <ItemGroup>
    <EmbeddedResource Include="Microsoft.Xna.Framework.RuntimeProfile" />
  </ItemGroup>
  <ItemGroup>
    <None Include="app.manifest" />
  </ItemGroup>

  <!-- Copy content files, but exclude sounds directory (we'll handle it separately). -->
  <ItemGroup>
    <None
      Include="..\content\**"
      Exclude="..\content\sounds\**"
    >
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
      <Link>content\%(RecursiveDir)%(Filename)%(Extension)</Link>
    </None>
  </ItemGroup>

  <ItemGroup>
    <None Remove="..\content\content.mgcb" />
    <None Remove="..\content\bin\**\*.*" />
    <None Remove="..\content\obj\**\*.*" />
    <None Remove="..\content\**\*.png" />
    <None Remove="..\content\sounds\sfx\*.wav" />
  </ItemGroup>

  <!-- Windows DirectX build, include *_windows.xnb and *_windows.wav pairs. -->
  <ItemGroup Condition="'$(TargetFramework)' == 'net9.0-windows'">
    <None Include="..\content\sounds\*_windows.xnb">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
      <Link>content\sounds\%(Filename)%(Extension)</Link>
    </None>
    <None Include="..\content\sounds\*_windows.wav">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
      <Link>content\sounds\%(Filename)%(Extension)</Link>
    </None>
  </ItemGroup>

  <!-- OpenGL build (Linux/macOS), include *.xnb and *.ogg pairs (excluding *_windows.*). -->
  <ItemGroup Condition="'$(TargetFramework)' == 'net9.0'">
    <None
      Include="..\content\sounds\*.xnb"
      Exclude="..\content\sounds\*_windows.xnb"
    >
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
      <Link>content\sounds\%(Filename)%(Extension)</Link>
    </None>
    <None Include="..\content\sounds\*.ogg">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
      <Link>content\sounds\%(Filename)%(Extension)</Link>
    </None>
  </ItemGroup>

  <!-- OpenGL build (Linux/macOS), include alsoft.ini to disable HTRF. -->
  <ItemGroup Condition="'$(TargetFramework)' == 'net9.0'">
    <None Include="..\alsoft.ini">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
    </None>
  </ItemGroup>

  <ItemGroup Condition="'$(RunMGCB)' == 'true'">
    <MonoGameContentReference Include="..\content\content.mgcb" />
  </ItemGroup>

  <ItemGroup Condition="'$(TargetFramework)' == 'net9.0-windows'">
    <EmbeddedResource Include="../distribution/icons/CutTheRopeIcon.ico">
      <LogicalName>Icon.ico</LogicalName>
    </EmbeddedResource>
  </ItemGroup>

  <ItemGroup Condition="'$(TargetFramework)' == 'net9.0'">
    <EmbeddedResource Include="../distribution/icons/CutTheRopeIcon.bmp">
      <LogicalName>Icon.bmp</LogicalName>
    </EmbeddedResource>
  </ItemGroup>

  <ItemGroup Condition="'$(RuntimeIdentifier)' != '' AND $(RuntimeIdentifier.StartsWith('osx'))">
    <None Include="../distribution/icons/CutTheRopeIcon.icns">
      <Link>icons/CutTheRopeIcon.icns</Link>
      <CopyToOutputDirectory>Never</CopyToOutputDirectory>
      <CopyToPublishDirectory>Always</CopyToPublishDirectory>
    </None>
  </ItemGroup>

  <Target
    Name="RestoreDotnetTools"
    BeforeTargets="CollectPackageReferences"
  >
    <Message
      Text="Restoring dotnet tools (this might take a while depending on your internet speed and should only happen upon building your project for the first time, or after upgrading MonoGame, or clearing your nuget cache)"
      Importance="High"
    />
    <Exec Command="dotnet tool restore" />
  </Target>
</Project>
