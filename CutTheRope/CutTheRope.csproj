<?xml version="1.0" encoding="utf-8"?>
<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <ProjectGuid>{9A732C70-39B7-456E-8029-91F641C29567}</ProjectGuid>
    <OutputType Condition="'$(Configuration)' == 'Debug'">Exe</OutputType>
    <OutputType Condition="'$(Configuration)' == 'Release'">WinExe</OutputType>
    <RootNamespace>CutTheRope</RootNamespace>
    <AssemblyName>CutTheRope-DX</AssemblyName>

    <!--
      DesktopGL build for all platforms:
        - Windows and Linux use LibVLC for video playback
        - macOS will use AVFoundation (to be implemented)
    -->

    <TargetFramework>net9.0</TargetFramework>

    <AllowUnsafeBlocks>True</AllowUnsafeBlocks>
    <ApplicationIcon Condition="$([MSBuild]::IsOsPlatform('Windows'))">../distribution/icons/CutTheRopeIcon.ico</ApplicationIcon>
    <AssemblyVersion>2.4.10.1</AssemblyVersion>
    <FileVersion>2.4.10.1</FileVersion>
    <InformationalVersion>2.4.10.1</InformationalVersion>
    <Company>ZeptoLab</Company>
    <Product>Cut The Rope: DX</Product>
    <Description>Cut the Rope: DX, a fan-made enhancement of the PC version of Cut the Rope.</Description>
    <Copyright>Copyright Â© 2012</Copyright>
    <NeutralLanguage>en-US</NeutralLanguage>
    <EnableNETAnalyzers>true</EnableNETAnalyzers>
    <AnalysisMode>Recommended</AnalysisMode>
    <EnforceCodeStyleInBuild>true</EnforceCodeStyleInBuild>
    <CodeAnalysisTreatWarningsAsErrors>false</CodeAnalysisTreatWarningsAsErrors>
    <TieredCompilation>false</TieredCompilation>
    <IncludeSourceRevisionInInformationalVersion>false</IncludeSourceRevisionInInformationalVersion>

    <!-- Default: build content -->
    <RunMGCB>true</RunMGCB>

    <!-- Auto-disable in CI (GitHub Actions, GitLab, Azure, etc. set CI=true) -->
    <RunMGCB Condition="'$(CI)' == 'true'">false</RunMGCB>
  </PropertyGroup>

  <!-- DesktopGL publish defaults -->
  <PropertyGroup Condition="'$(RuntimeIdentifier)' != ''">
    <SelfContained>true</SelfContained>
    <PublishSingleFile>true</PublishSingleFile>
    <PublishReadyToRun>false</PublishReadyToRun>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="DiscordRichPresence" Version="1.6.1.70" />
    <PackageReference
      Include="FontStashSharp.MonoGame"
      Version="1.5.2"
    />
    <PackageReference
      Include="MonoGame.Content.Builder.Task"
      Version="3.8.4.1"
    />
    <PackageReference
      Include="MonoGame.Framework.DesktopGL"
      Version="3.8.4.1"
    />
  </ItemGroup>

  <!-- VLC video player for Windows and Linux (macOS uses AVFoundation) -->
  <ItemGroup
    Condition="!$(RuntimeIdentifier.StartsWith('osx')) AND ( '$(RuntimeIdentifier)' != '' OR !$([MSBuild]::IsOsPlatform('OSX')) )">
    <PackageReference Include="LibVLCSharp" Version="3.9.5" />
  </ItemGroup>

  <!-- Windows: bundled native VLC libraries -->
  <ItemGroup
    Condition="$(RuntimeIdentifier.StartsWith('win')) OR ( '$(RuntimeIdentifier)' == '' AND $([MSBuild]::IsOsPlatform('Windows')) )">
    <PackageReference Include="VideoLAN.LibVLC.Windows" Version="3.0.23" />
  </ItemGroup>

  <!-- Compiler constants for DesktopGL builds. -->
  <PropertyGroup>
    <DefineConstants>$(DefineConstants);MONOGAME_DESKTOPGL</DefineConstants>
  </PropertyGroup>

  <!-- VLC enabled on all platforms except macOS (which uses AVFoundation) -->
  <PropertyGroup
    Condition="!$(RuntimeIdentifier.StartsWith('osx')) AND ( '$(RuntimeIdentifier)' != '' OR !$([MSBuild]::IsOsPlatform('OSX')) )">
    <DefineConstants>$(DefineConstants);DESKTOPGL_VLC</DefineConstants>
  </PropertyGroup>

  <ItemGroup>
    <EmbeddedResource Include="Microsoft.Xna.Framework.RuntimeProfile" />
  </ItemGroup>
  <ItemGroup>
    <None Include="app.manifest" />
  </ItemGroup>

  <!-- Copy content files, but exclude sounds directory (we'll handle it separately). -->
  <ItemGroup>
    <None
      Include="..\content\**"
      Exclude="..\content\sounds\**"
    >
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
      <Link>content\%(RecursiveDir)%(Filename)%(Extension)</Link>
    </None>
  </ItemGroup>

  <ItemGroup>
    <None Remove="..\content\content.mgcb" />
    <None Remove="..\content\bin\**\*.*" />
    <None Remove="..\content\obj\**\*.*" />
    <None Remove="..\content\**\*.png" />
    <None Remove="..\content\sounds\sfx\*.wav" />
  </ItemGroup>

  <!-- DesktopGL build: include *.xnb and *.ogg pairs. -->
  <ItemGroup>
    <None Include="..\content\sounds\*.xnb">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
      <Link>content\sounds\%(Filename)%(Extension)</Link>
    </None>
    <None Include="..\content\sounds\*.ogg">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
      <Link>content\sounds\%(Filename)%(Extension)</Link>
    </None>
  </ItemGroup>

  <!-- Include alsoft.ini to disable HTRF. -->
  <ItemGroup>
    <None Include="..\alsoft.ini">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
    </None>
  </ItemGroup>

  <ItemGroup Condition="'$(RunMGCB)' == 'true'">
    <MonoGameContentReference Include="..\content\content.mgcb" />
  </ItemGroup>

  <ItemGroup>
    <EmbeddedResource Include="../distribution/icons/CutTheRopeIcon.bmp">
      <LogicalName>Icon.bmp</LogicalName>
    </EmbeddedResource>
  </ItemGroup>

  <ItemGroup Condition="'$(RuntimeIdentifier)' != '' AND $(RuntimeIdentifier.StartsWith('osx'))">
    <None Include="../distribution/icons/CutTheRopeIcon.icns">
      <Link>icons/CutTheRopeIcon.icns</Link>
      <CopyToOutputDirectory>Never</CopyToOutputDirectory>
      <CopyToPublishDirectory>Always</CopyToPublishDirectory>
    </None>
  </ItemGroup>

  <Target
    Name="RestoreDotnetTools"
    BeforeTargets="CollectPackageReferences"
  >
    <Message
      Text="Restoring dotnet tools (this might take a while depending on your internet speed and should only happen upon building your project for the first time, or after upgrading MonoGame, or clearing your nuget cache)"
      Importance="High"
    />
    <Exec Command="dotnet tool restore" />
  </Target>
</Project>
